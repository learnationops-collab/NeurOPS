{% extends "layouts/base.html" %}

{% block content %}
<div class="flex h-screen overflow-hidden">
    {% include "includes/closer_sidebar.html" %}
    <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-50">
        <div class="px-6 py-8">
            <div class="mb-8 flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">Reporte Diario</h1>
                    <p class="text-gray-500 mt-1">{{ today.strftime('%d de %B, %Y') }}</p>
                </div>
                <div class="flex items-center gap-4">
                    {% if today_stats %}
                    <span
                        class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                        Enviado (Actualizar)
                    </span>
                    {% else %}
                    <span
                        class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                        Pendiente
                    </span>
                    {% endif %}

                    <button type="submit" form="dailyReportForm"
                        class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg shadow-md text-sm transition-all hover:scale-105">
                        Guardar Reporte
                    </button>
                </div>
            </div>

            <!-- Automated KPIs Card -->
            <!-- Row 1: Activity & Volume -->
            <h3 class="text-lg font-bold text-gray-700 mb-2">Actividad y Volumen</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <!-- Agendas Total -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <p class="text-xs font-bold text-gray-500 uppercase tracking-wide">Agendas Totales</p>
                            <h2 class="text-3xl font-bold text-gray-800 mt-1">{{ kpi_scheduled }}</h2>
                        </div>
                        <div class="p-2 bg-indigo-50 rounded-lg text-indigo-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z">
                                </path>
                            </svg>
                        </div>
                    </div>
                    <div class="space-y-2 text-xs">
                        <div class="flex justify-between">
                            <span class="text-gray-500">Completadas</span>
                            <span class="font-bold text-gray-800">{{ kpi_completed }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">No Show</span>
                            <span class="font-bold text-red-600">{{ kpi_no_show }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">Canceladas</span>
                            <span class="font-bold text-gray-600">{{ kpi_canceled }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">Reprogramadas (Nuevas)</span>
                            <span class="font-bold text-blue-600">{{ kpi_reschedules }}</span>
                        </div>
                    </div>
                </div>

                <!-- Second Agendas -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <p class="text-xs font-bold text-gray-500 uppercase tracking-wide">Segundas Agendas</p>
                            <h2 class="text-3xl font-bold text-gray-800 mt-1">{{ kpi_second_agendas }}</h2>
                        </div>
                        <div class="p-2 bg-yellow-50 rounded-lg text-yellow-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                                </path>
                            </svg>
                        </div>
                    </div>
                    <div class="space-y-2 text-xs">
                        <div class="flex justify-between">
                            <span class="text-gray-500">Completadas</span>
                            <span class="font-bold text-gray-800">{{ kpi_second_agendas_completed }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">No Show</span>
                            <span class="font-bold text-red-600">{{ kpi_second_agendas_noshow }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">Canceladas</span>
                            <span class="font-bold text-gray-600">{{ kpi_second_agendas_canceled }}</span>
                        </div>
                        <div class="h-4"></div> <!-- Spacer align -->
                    </div>
                </div>
            </div>

            <!-- Row 2: Conversion & Results -->
            <h3 class="text-lg font-bold text-gray-700 mb-2">Conversión y Resultados</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <!-- Presentations -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-l-4 border-l-indigo-500">
                    <div class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">Presentaciones</div>
                    <div class="text-3xl font-bold text-indigo-900">{{ kpi_presentations }}</div>
                    <div class="mt-2 text-xs text-indigo-600 font-medium">
                        {{ "%.1f"|format(kpi_closing_rate_pres) }}% de Completadas
                    </div>
                </div>

                <!-- Sales -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-l-4 border-l-green-500">
                    <div class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">Cierres / Ventas</div>
                    <div class="text-3xl font-bold text-green-900">{{ kpi_sales_count }}</div>
                    <div class="mt-2 text-xs text-gray-500">
                        ${{ "{:,.0f}".format(kpi_sales_amount) }} (Volumen)
                    </div>
                    <div class="text-xs text-green-600 font-bold">
                        ${{ "{:,.0f}".format(kpi_cash_collected) }} (Cash)
                    </div>
                </div>

                <!-- Show Up Rate -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-l-4 border-l-blue-500">
                    <div class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">Show Up Rate</div>
                    <div class="text-3xl font-bold text-blue-900">{{ "%.1f"|format(kpi_show_rate) }}%</div>
                    <div class="mt-2 text-xs text-blue-600 font-medium">
                        Completadas / Totales
                    </div>
                </div>

                <!-- Closing Rate Global -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-l-4 border-l-purple-500">
                    <div class="text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">Cierre Global</div>
                    <div class="text-3xl font-bold text-purple-900">{{ "%.1f"|format(kpi_closing_rate) }}%</div>
                    <div class="mt-2 text-xs text-purple-600 font-medium">
                        Cierres / Completadas
                    </div>
                </div>
            </div>

            <!-- Row 3: Operational Metrics -->
            <h3 class="text-lg font-bold text-gray-700 mb-2">Métricas Operativas</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-8">
                {% set cancel_rate = (kpi_canceled / kpi_scheduled * 100) if kpi_scheduled > 0 else 0 %}
                {% set resched_rate = (kpi_reschedules / kpi_scheduled * 100) if kpi_scheduled > 0 else 0 %}

                <div class="bg-white p-4 rounded-lg shadow-sm">
                    <p class="text-xs text-gray-500 uppercase">Tasa Cancelación</p>
                    <p class="text-xl font-bold text-gray-700">{{ "%.1f"|format(cancel_rate) }}%</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm">
                    <p class="text-xs text-gray-500 uppercase">Tasa Reprogramación</p>
                    <p class="text-xl font-bold text-gray-700">{{ "%.1f"|format(resched_rate) }}%</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm">
                    <p class="text-xs text-gray-500 uppercase">Ticket Promedio</p>
                    <p class="text-xl font-bold text-gray-700">${{ "{:,.0f}".format(kpi_avg_ticket) }}</p>
                </div>
            </div>

            <!-- Questions Form -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">Checklist Diario</h3>
                </div>

                <form method="POST" class="p-6" id="dailyReportForm">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />

                    <div class="space-y-6">
                        <hr class="border-gray-100">

                        {% for q in questions %}
                        <div>
                            <label for="question_{{ q.id }}" class="block text-sm font-medium text-gray-700 mb-2">
                                {{ loop.index }}. {{ q.text }}
                            </label>

                            {% if q.question_type == 'boolean' %}
                            <div class="flex items-center">
                                <input type="checkbox" id="question_{{ q.id }}" name="question_{{ q.id }}"
                                    class="h-5 w-5 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded" {% if
                                    today_stats and today_stats.answers.filter_by(question_id=q.id).first() and
                                    today_stats.answers.filter_by(question_id=q.id).first().answer=='Sí' %}checked{%
                                    endif %}>
                                <label for="question_{{ q.id }}" class="ml-2 block text-sm text-gray-900">
                                    Sí / Completado
                                </label>
                            </div>
                            {% elif q.question_type == 'number' %}
                            <input type="number" id="question_{{ q.id }}" name="question_{{ q.id }}"
                                class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md"
                                value="{{ today_stats.answers.filter_by(question_id=q.id).first().answer if today_stats and today_stats.answers.filter_by(question_id=q.id).first() else '' }}">
                            {% else %}
                            <textarea id="question_{{ q.id }}" name="question_{{ q.id }}" rows="3"
                                class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md"
                                placeholder="Escribe tu respuesta aquí...">{{ today_stats.answers.filter_by(question_id=q.id).first().answer if today_stats and today_stats.answers.filter_by(question_id=q.id).first() else '' }}</textarea>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>


                </form>
            </div>
        </div>
    </main>
</div>
{% endblock %}