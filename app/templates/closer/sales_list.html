{% extends "layouts/base.html" %}

{% block content %}
<div class="flex h-screen overflow-hidden">
    {% include "includes/closer_sidebar.html" ignore missing %}

    <main
        class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-50 dark:bg-gray-900 p-6 transition-colors duration-300">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold text-gray-800 dark:text-white">Mis Ventas</h1>
        </div>

        <!-- KPIs Cards -->
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
            <!-- Count -->
            <div
                class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-4 border border-gray-100 dark:border-gray-700 flex flex-col justify-center items-center relative overflow-hidden">
                <span
                    class="text-gray-400 dark:text-gray-500 text-xs font-bold uppercase tracking-widest mb-1">Transacciones</span>
                <span id="kpi-sales-count" class="text-2xl font-bold text-gray-800 dark:text-white">{{ kpis.count
                    }}</span>
            </div>

            <!-- Gross Revenue (Maybe less relevant for closer but good to know volume) -->
            <div
                class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-4 border-l-4 border-blue-500 flex flex-col justify-center items-center">
                <span class="text-gray-400 dark:text-gray-500 text-xs font-bold uppercase tracking-widest mb-1">Total
                    (Bruto)</span>
                <span id="kpi-revenue" class="text-2xl font-bold text-blue-600 text-center">${{
                    "{:,.0f}".format(kpis.revenue) }}</span>
            </div>

            <!-- Cash Collect (Net) - Basis for Commission -->
            <div
                class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-4 border-l-4 border-green-500 flex flex-col justify-center items-center">
                <span class="text-gray-400 dark:text-gray-500 text-xs font-bold uppercase tracking-widest mb-1">Cash
                    Collect (Neto)</span>
                <span id="kpi-cash-collected" class="text-2xl font-bold text-green-600 text-center">${{
                    "{:,.0f}".format(kpis.cash_collected)
                    }}</span>
            </div>

            <!-- My Commission -->
            <div
                class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-4 border-l-4 border-purple-500 flex flex-col justify-center items-center relative overflow-hidden">
                <div class="absolute top-0 right-0 p-2 opacity-10">
                    <i class="fas fa-gem text-5xl text-purple-500 transform rotate-12"></i>
                </div>
                <span class="text-gray-400 dark:text-gray-500 text-xs font-bold uppercase tracking-widest mb-1">Mi
                    Comisión (10%)</span>
                <span id="kpi-commission" class="text-2xl font-bold text-purple-600 text-center">${{
                    "{:,.0f}".format(kpis.my_commission)
                    }}</span>
            </div>

            <!-- Debt -->
            <div
                class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-4 border-l-4 border-red-500 flex flex-col justify-center items-center">
                <span class="text-gray-400 dark:text-gray-500 text-xs font-bold uppercase tracking-widest mb-1">Deuda
                    Activa</span>
                <span id="kpi-debt" class="text-2xl font-bold text-red-600 text-center">${{ "{:,.0f}".format(kpis.debt)
                    }}</span>
            </div>
        </div>

        <!-- Filter Form -->
        <div
            class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md mb-6 border border-gray-100 dark:border-gray-700">
            <form id="filterForm" method="get" action="{{ url_for('closer.sales_list') }}"
                class="flex flex-wrap gap-4 items-end">

                <!-- Search -->
                <div class="flex-1 min-w-[200px]">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Buscar</label>
                    <input type="text" name="search" value="{{ search }}"
                        class="focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-400"
                        placeholder="Cliente...">
                </div>

                <!-- Program -->
                <div class="w-40">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Programa</label>
                    <select name="program"
                        class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                        <option value="">Todos</option>
                        {% for p in programs %}
                        <option value="{{ p.id }}" {% if program_filter==p.id|string %}selected{% endif %}>{{ p.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Method -->
                <div class="w-40">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Método</label>
                    <select name="method"
                        class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                        <option value="">Todos</option>
                        {% for m in methods %}
                        <option value="{{ m.id }}" {% if method_filter==m.id %}selected{% endif %}>{{ m.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Type -->
                <div class="w-40">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tipo</label>
                    <select name="type"
                        class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                        <option value="">Todos</option>
                        <option value="full" {% if type_filter=='full' %}selected{% endif %}>Completo</option>
                        <option value="installment" {% if type_filter=='installment' %}selected{% endif %}>Cuota
                        </option>
                        <option value="down_payment" {% if type_filter=='down_payment' %}selected{% endif %}>Inicial
                        </option>
                        <option value="renewal" {% if type_filter=='renewal' %}selected{% endif %}>Renovación</option>
                    </select>
                </div>

                <!-- Dates -->
                <div class="w-32">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Desde</label>
                    <input type="date" name="start_date" value="{{ start_date }}"
                        class="focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                </div>
                <div class="w-32">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Hasta</label>
                    <input type="date" name="end_date" value="{{ end_date }}"
                        class="focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                </div>

                <div class="flex items-center gap-2 pb-0.5">
                    <button type="submit"
                        class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none">
                        Filtrar
                    </button>
                    <a href="{{ url_for('closer.sales_list', clear=1) }}"
                        class="inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                        Limpiar
                    </a>
                </div>
            </form>
        </div>

        <div class="flex justify-end mb-4 gap-2">
            <!-- Closer can manually add sales via generic button? Or usually via Lead Detail. 
                  Let's provide the button just in case, redirects to search/select lead. -->
            <a href="{{ url_for('closer.create_sale') }}"
                class="bg-green-600 hover:green-700 text-white font-bold py-2 px-4 rounded shadow-md transition duration-150 ease-in-out">
                <i class="fas fa-plus mr-2"></i>Nueva Venta
            </a>
        </div>

        <div
            class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
            <table class="w-full text-left">
                <thead
                    class="bg-gray-50 dark:bg-gray-700 border-b border-gray-200 dark:border-gray-700 text-gray-500 dark:text-gray-400 uppercase text-xs">
                    <tr>
                        <th class="px-6 py-3 font-semibold">#</th>
                        <th class="px-6 py-3 font-semibold">Cliente</th>
                        <th class="px-6 py-3 font-semibold">Programa</th>
                        <th class="px-6 py-3 font-semibold text-center">Método</th>
                        <th class="px-6 py-3 font-semibold text-right">Monto</th>
                        <th class="px-6 py-3 font-semibold">Fecha</th>
                        <th class="px-6 py-3 font-semibold text-right">Acciones</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100 dark:divide-gray-700 dark:text-gray-300">
                    {% include 'closer/partials/sales_rows.html' %}
                </tbody>
            </table>
            {% if not payments %}
            <div class="p-8 text-center text-gray-500">No hay ventas registradas con estos filtros.</div>
            {% endif %}
        </div>

        <div class="mt-4 text-center">
            {% if pagination.has_next %}
            <button id="loadMoreBtn" type="button"
                class="bg-indigo-600 text-white px-6 py-2 rounded-full font-bold shadow hover:bg-indigo-700 transition">
                Cargar más
            </button>
            {% endif %}
            <div id="loadingMore" class="hidden text-gray-500 mt-2">
                <i class="fas fa-spinner fa-spin mr-2"></i> Cargando...
            </div>
        </div>

        <script>
            let currentPage = {{ pagination.page }};
            const loadMoreBtn = document.getElementById('loadMoreBtn');
            const loadingMore = document.getElementById('loadingMore');
            const tableBody = document.querySelector('tbody');
            const filterForm = document.getElementById('filterForm');

            // Debounce
            function debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            function updateSales(page = 1, append = false) {
                const formData = new FormData(filterForm);
                const params = new URLSearchParams(formData);
                params.set('ajax', '1');
                params.set('page', page);

                if (append) {
                    loadMoreBtn.classList.add('hidden');
                    loadingMore.classList.remove('hidden');
                } else {
                    tableBody.style.opacity = '0.5';
                }

                // Update URL
                if (!append) {
                    const url = new URL(window.location);
                    formData.forEach((value, key) => url.searchParams.set(key, value));
                    window.history.pushState({}, '', url);
                }

                fetch(`{{ url_for('closer.sales_list') }}?${params.toString()}`)
                    .then(response => response.json())
                    .then(data => {
                        if (append) {
                            tableBody.insertAdjacentHTML('beforeend', data.html);
                            loadingMore.classList.add('hidden');
                        } else {
                            tableBody.innerHTML = data.html;
                            tableBody.style.opacity = '1';
                        }

                        // Update KPIs
                        if (data.kpis) {
                            if (document.getElementById('kpi-sales-count'))
                                document.getElementById('kpi-sales-count').innerText = data.kpis.sales_count;
                            if (document.getElementById('kpi-revenue'))
                                document.getElementById('kpi-revenue').innerText = '$' + data.kpis.revenue;
                            if (document.getElementById('kpi-cash-collected'))
                                document.getElementById('kpi-cash-collected').innerText = '$' + data.kpis.cash_collected;
                            if (document.getElementById('kpi-commission'))
                                document.getElementById('kpi-commission').innerText = '$' + data.kpis.my_commission;
                            if (document.getElementById('kpi-debt'))
                                document.getElementById('kpi-debt').innerText = '$' + data.kpis.debt;
                        }

                        // Pagination
                        if (data.has_next) {
                            loadMoreBtn.classList.remove('hidden');
                        } else {
                            loadMoreBtn.classList.add('hidden');
                        }

                        currentPage = page;
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        tableBody.style.opacity = '1';
                        loadingMore.classList.add('hidden');
                        if (append) loadMoreBtn.classList.remove('hidden');
                    });
            }

            // Bind Inputs
            const inputs = filterForm.querySelectorAll('input, select');
            inputs.forEach(input => {
                if (input.name === 'search') {
                    input.addEventListener('input', debounce(() => updateSales(1), 500));
                } else {
                    input.addEventListener('change', () => updateSales(1));
                }
            });

            // Prevent Form Submit (Refresh)
            filterForm.addEventListener('submit', (e) => {
                e.preventDefault();
                updateSales(1);
            });

            // Bind Load More
            if (loadMoreBtn) {
                loadMoreBtn.addEventListener('click', function () {
                    updateSales(currentPage + 1, true);
                });
            }
        </script>

    </main>
</div>
{% endblock %}