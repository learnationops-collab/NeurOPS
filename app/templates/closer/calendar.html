{% extends "layouts/base.html" %}

{% block title %}Mi Calendario{% endblock %}

{% block content %}
<div class="flex h-screen overflow-hidden">
    {% include "includes/closer_sidebar.html" %}

    <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-50 p-6">
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">Configurar Disponibilidad</h1>
                <p class="text-sm text-gray-500">Arrastra para seleccionar bloques. No olvides guardar.</p>
            </div>

            <div class="flex items-center bg-white rounded-lg shadow-sm border border-gray-200">
                <a href="{{ url_for('closer.calendar', offset=week_offset - 1) }}"
                    class="px-3 py-2 border-r border-gray-200 hover:bg-gray-50 text-gray-600">
                    &larr; Semana Anterior
                </a>
                <span class="px-4 py-2 font-medium text-gray-700 text-sm">
                    {{ week_dates[0].strftime('%d %b') }} - {{ week_dates[-1].strftime('%d %b') }}
                </span>
                <a href="{{ url_for('closer.calendar', offset=week_offset + 1) }}"
                    class="px-3 py-2 border-l border-gray-200 hover:bg-gray-50 text-gray-600">
                    Siguiente Semana &rarr;
                </a>
            </div>

            <button onclick="saveAvailability()"
                class="bg-indigo-600 text-white px-6 py-2 rounded shadow hover:bg-indigo-700 transition font-bold disabled:opacity-50 disabled:cursor-not-allowed"
                id="saveBtn">
                Guardar Cambios
            </button>
        </div>

        <!-- Generator Tool -->
        <div class="bg-indigo-50 border border-indigo-100 rounded-lg p-4 mb-6">
            <h3 class="text-sm font-bold text-indigo-900 mb-3 flex items-center">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                </svg>
                Autocompletar Horario
            </h3>
            <div class="flex flex-wrap gap-4 items-end">
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">Días</label>
                    <div class="flex gap-2">
                        {% set days = ['Lun', 'Mar', 'Mie', 'Jue', 'Vie', 'Sab', 'Dom'] %}
                        {% for i in range(7) %}
                        <label class="inline-flex items-center">
                            <input type="checkbox"
                                class="day-check w-4 h-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500"
                                value="{{ i }}" {% if i < 5 %}checked{% endif %}>
                            <span class="ml-1 text-xs text-gray-700">{{ days[i] }}</span>
                        </label>
                        {% endfor %}
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">Desde</label>
                    <select id="startHour"
                        class="block w-20 text-sm border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        {% for h in range(24) %}<option value="{{h}}" {% if h==8 %}selected{% endif %}>{{
                            "%02d"|format(h) }}:00</option>{% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">Hasta</label>
                    <select id="endHour"
                        class="block w-20 text-sm border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                        {% for h in range(24) %}<option value="{{h}}" {% if h==18 %}selected{% endif %}>{{
                            "%02d"|format(h) }}:00</option>{% endfor %}
                    </select>
                </div>
                <button onclick="applyBaseSchedule()"
                    class="bg-indigo-600 text-white px-4 py-2 rounded text-xs font-bold hover:bg-indigo-700 transition">
                    Aplicar a Vista
                </button>
            </div>
            <p class="text-xs text-indigo-400 mt-2 font-light"> * Esto seleccionará los bloques. Recuerda guardar
                después.</p>
        </div>

        <div class="flex gap-4 mb-4 text-xs font-medium">
            <div class="flex items-center gap-1"><span
                    class="w-4 h-4 bg-green-200 border border-green-400 rounded"></span> Seleccionado (Guardar)</div>
            <div class="flex items-center gap-1"><span
                    class="w-4 h-4 bg-green-500 border border-green-600 rounded"></span> Guardado</div>
            <div class="flex items-center gap-1"><span
                    class="w-4 h-4 bg-gray-200 border border-gray-300 rounded"></span> Pasado / Bloqueado</div>
        </div>

        <!-- Calendar Grid -->
        <div class="bg-white rounded-xl shadow border border-gray-200 overflow-hidden select-none" id="calendarGrid">
            <div
                class="grid grid-cols-8 border-b border-gray-200 bg-gray-50 text-center text-xs font-semibold text-gray-500 uppercase sticky top-0 z-10">
                <div class="p-3 border-r border-gray-200">Hora</div>
                {% for d in week_dates %}
                <div class="p-3 border-r border-gray-200 {% if d == today %} bg-indigo-50 text-indigo-700 {% endif %}">
                    {{ d.strftime('%a %d') }}
                </div>
                {% endfor %}
            </div>

            <div class="max-h-[70vh] overflow-y-auto">
                {% for hour in range(0, 24) %}
                <div class="grid grid-cols-8 border-b border-gray-100 text-sm">
                    <!-- Time Label -->
                    <div
                        class="p-2 border-r border-gray-100 text-center text-gray-400 font-mono text-xs flex items-center justify-center">
                        {{ "%02d"|format(hour) }}:00
                    </div>

                    <!-- Days Cols 0-6 -->
                    {% for day_idx in range(0, 7) %}
                    {% set current_date = week_dates[day_idx] %}

                    {# Logic: Block if date is past OR (date is today AND hour is past) #}
                    {% set is_past = false %}
                    {% if current_date < today %} {% set is_past=true %} {% elif current_date==today and hour <=now.hour
                        %} {# Blocking current hour too (<=) or just strictly past (<)? User said "passed" . Usually
                        14:00 is past if it is 14:01. So <=is safer for "passed blocks" . #} {% set is_past=true %} {%
                        endif %} {# Use namespace to handle scoping inside loop #} {% set ns=namespace(booked=false,
                        has_appt=false) %} {# Check Availabilities #} {% for a in availabilities %} {% if
                        a.date|string==current_date|string and a.start_time.hour==hour %} {% set ns.booked=true %} {%
                        endif %} {% endfor %} {# Check Appointments (Agendados) #} {% for appt in appointments %} {#
                        Convert UTC DB time to Closer Local Time #} {% set tz=pytz.timezone(current_user.timezone
                        or 'America/La_Paz' ) %} {# Ensure UTC awareness before conversion #} {% set
                        local_start=appt.start_time.replace(tzinfo=pytz.utc).astimezone(tz) %} {% if
                        local_start.date()|string==current_date|string and local_start.hour==hour %} {% set
                        ns.has_appt=true %} {% endif %} {% endfor %} <div
                        class="border-r border-gray-100 relative h-10 slot-cell 
                             {% if is_past %} bg-gray-200 cursor-not-allowed opacity-50
                             {% elif ns.has_appt %} bg-red-100 border-red-200 cursor-not-allowed
                             {% else %} cursor-pointer hover:bg-gray-50 {% endif %}
                             {% if ns.booked and not is_past and not ns.has_appt %} bg-green-500 hover:bg-green-600 border-green-600 text-white {% endif %}"
                        data-date="{{ current_date }}" data-hour="{{ " %02d"|format(hour) }}"
                        data-ispast="{{ is_past }}" data-hasappt="{{ ns.has_appt }}" data-booked="{{ ns.booked }}"
                        ondragstart="return false;" onmousedown="startSelection(this)"
                        onmouseover="updateSelection(this)" onmouseup="endSelection()">

                        {% if ns.has_appt %}
                        <div class="absolute inset-0 flex items-center justify-center">
                            <span class="text-[10px] text-red-600 font-bold rotate-[-15deg] opacity-80">OCUPADO</span>
                        </div>
                        {% endif %}
                </div>
                {% endfor %}
            </div>
            {% endfor %}
        </div>
</div>
</main>
</div>

<script>
    let isSelecting = false;
    let initialState = false; // Are we turning ON or OFF?

    function startSelection(el) {
        if (el.dataset.ispast === 'True') return;
        isSelecting = true;
        // Determine intent based on clicked cell's current state
        // If it's already green (saved) or light green (selected), we are turning OFF.
        // Wait, 'bg-green-500' is saved. 'bg-green-200' is new selection.
        const hasGreen = el.classList.contains('bg-green-200') || el.classList.contains('bg-green-500');
        initialState = !hasGreen; // If it has green, we want to remove it (false).

        toggleCell(el, initialState);
    }

    function updateSelection(el) {
        if (isSelecting && el.dataset.ispast !== 'True') {
            toggleCell(el, initialState);
        }
    }

    function endSelection() {
        isSelecting = false;
    }

    // Attach mouseup to window to catch releases outside grid
    window.addEventListener('mouseup', endSelection);

    function toggleCell(el, state) {
        // Remove old classes to avoid confusion
        el.classList.remove('bg-green-500', 'hover:bg-green-600', 'border-green-600', 'text-white'); // Remove 'Saved' look

        if (state) {
            el.classList.add('bg-green-200', 'hover:bg-green-300', 'border', 'border-green-400');
            el.dataset.selected = "true";
        } else {
            el.classList.remove('bg-green-200', 'hover:bg-green-300', 'border', 'border-green-400');
            el.dataset.selected = "false";
        }
    }

    function applyBaseSchedule() {
        const startH = parseInt(document.getElementById('startHour').value);
        const endH = parseInt(document.getElementById('endHour').value);

        const dayChecks = document.querySelectorAll('.day-check:checked');
        const activeDays = Array.from(dayChecks).map(cb => parseInt(cb.value));

        if (startH >= endH) {
            alert('La hora de inicio debe ser menor a la hora fin.');
            return;
        }

        // Iterate grid columns (days)
        // We know structure: Grid Cols = [TimeLabel, Day0, Day1, ..., Day6]
        // But our cells are flat per row.
        // Easier: Iterate all cells and check their data attributes.
        // We don't have day index in data-attr, but we can compute it from index or add it.
        // Actually, logic: for each row (hour), if hour in range, toggle cells for active days.

        const cells = document.querySelectorAll('.slot-cell');
        // We need to map Date -> Day Index (0-6) relative to this view.
        // Or simpler: The loop in template renders days in order 0..6.
        // Let's rely on DOM order or calculate day from date.
        // Since we have date, we can getDay(), but Monday is 0 or 1?
        // JS getDay(): 0=Sun, 1=Mon.
        // Python weekday(): 0=Mon, 6=Sun.
        // Our template renders 0=Mon .. 6=Sun.
        // So JS Day 1 -> Template Day 0. JS Day 0 -> Template Day 6.

        cells.forEach(cell => {
            if (cell.dataset.ispast === 'True') return;

            const cellDate = new Date(cell.dataset.date + 'T12:00:00'); // Safe parsing
            // Adjust JS Sunday(0) to Python Sunday(6)
            let jsDay = cellDate.getDay();
            let pyDay = jsDay === 0 ? 6 : jsDay - 1;

            const cellHour = parseInt(cell.dataset.hour);

            if (activeDays.includes(pyDay)) {
                if (cellHour >= startH && cellHour < endH) { // < EndH because 18:00 means until 18:00 (last block 17-18)
                    toggleCell(cell, true); // Turn ON
                }
            }
        });
    }

    function saveAvailability() {
        const btn = document.getElementById('saveBtn');
        btn.innerText = 'Guardando...';
        btn.disabled = true;

        const slots = [];
        // Find all cells that are effectively selected
        // This includes ones marked 'bg-green-200' (new) AND 'bg-green-500' (original saved ones, if not toggled off)
        // Actually, my toggle logic stripped bg-green-500 if touched. 
        // So we need to iterate ALL cells and check their visual state.

        document.querySelectorAll('.slot-cell').forEach(cell => {
            if (cell.dataset.ispast === 'True') return;

            // Check if visually active OR if it was available but hidden by appointment
            // If it has appointment (red), user couldn't toggle it. So preserve 'booked' state.
            let isSelected = false;

            if (cell.dataset.hasappt === 'True') {
                if (cell.dataset.booked === 'True') isSelected = true;
            } else {
                isSelected = cell.classList.contains('bg-green-200') || cell.classList.contains('bg-green-500');
            }

            if (isSelected) {
                slots.push({
                    date: cell.dataset.date,
                    hour: cell.dataset.hour + ':00' // Format HH:MM
                });
            }
        });

        if (slots.length === 0) {
            if (!confirm('¿Estás seguro que deseas borrar toda tu disponibilidad para esta semana?')) {
                btn.innerText = 'Guardar Cambios';
                btn.disabled = false;
                return;
            }
        }

        // Current week Start date for backend to know what range to wipe
        // We can grab it from the first header or first cell
        const weekStart = '{{ week_dates[0] }}';

        fetch('{{ url_for("closer.update_availability") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: JSON.stringify({
                week_start: weekStart,
                slots: slots
            })
        }).then(res => res.json()).then(data => {
            if (data.status === 'success') {
                alert('Guardado exitoso. Bloques guardados: ' + data.count);
                // Reload to show 'bg-green-500' state from server source of truth
                window.location.reload();
            } else {
                alert('Hubo un error al guardar: ' + data.msg);
                btn.innerText = 'Guardar Cambios';
                btn.disabled = false;
            }
        }).catch(err => {
            alert('Error de red: ' + err);
            btn.innerText = 'Guardar Cambios';
            btn.disabled = false;
        });
    }
</script>
{% endblock %}