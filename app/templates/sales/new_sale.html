{% extends "layouts/base.html" %}

{% block content %}
<div class="flex h-screen overflow-hidden">
    <!-- Include Sidebar based on Role -->
    {% if current_user.role == 'admin' %}
    {% include "includes/admin_sidebar.html" %}
    {% else %}
    <!-- Closer Sidebar -->
    {% include "includes/closer_sidebar.html" %}
    {% endif %}

    <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-50 p-8">
        <div class="max-w-2xl mx-auto bg-white rounded-lg shadow-sm border border-gray-200 p-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">{{ title }}</h2>

            <form method="POST" class="space-y-6"
                action="{{ url_for('admin.create_sale', next=next_url) if current_user.role == 'admin' else (url_for('closer.create_sale', next=next_url) if next_url else url_for('closer.create_sale')) }}">
                {{ form.hidden_tag() }}

                <!-- Lead Search Section -->
                <div class="relative">
                    {{ form.lead_search.label(class="block text-sm font-medium text-gray-700 mb-1") }}
                    {{ form.lead_search(class="w-full rounded-lg border-gray-300 focus:ring-indigo-500
                    focus:border-indigo-500 shadow-sm", placeholder="Escribe nombre, email o tel√©fono...",
                    autocomplete="off") }}

                    <!-- Dropdown Results -->
                    <div id="search-results"
                        class="absolute z-10 w-full bg-white shadow-lg border border-gray-200 mt-1 rounded-md hidden max-h-60 overflow-y-auto">
                        <!-- Items injected by JS -->
                    </div>
                </div>

                <!-- Program & Amount -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        {{ form.program_id.label(class="block text-sm font-medium text-gray-700 mb-1") }}
                        {{ form.program_id(class="w-full rounded-lg border-gray-300 focus:ring-indigo-500
                        focus:border-indigo-500 shadow-sm bg-white") }}
                    </div>
                    <div>
                        {{ form.amount.label(class="block text-sm font-medium text-gray-700 mb-1") }}
                        {{ form.amount(class="w-full rounded-lg border-gray-300 focus:ring-indigo-500
                        focus:border-indigo-500 shadow-sm", type="number", step="0.01") }}
                    </div>
                </div>

                <!-- Payment Details -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        {{ form.payment_type.label(class="block text-sm font-medium text-gray-700 mb-1") }}
                        {{ form.payment_type(class="w-full rounded-lg border-gray-300 focus:ring-indigo-500
                        focus:border-indigo-500 shadow-sm bg-white") }}
                    </div>
                    <div>
                        {{ form.payment_method_id.label(class="block text-sm font-medium text-gray-700 mb-1") }}
                        {{ form.payment_method_id(class="w-full rounded-lg border-gray-300 focus:ring-indigo-500
                        focus:border-indigo-500 shadow-sm bg-white") }}
                    </div>
                </div>

                <!-- Admin: Select Closer -->
                {% if form.closer_id %}
                <div>
                    {{ form.closer_id.label(class="block text-sm font-medium text-gray-700 mb-1") }}
                    {{ form.closer_id(class="w-full rounded-lg border-gray-300 focus:ring-indigo-500
                    focus:border-indigo-500 shadow-sm bg-white") }}
                </div>
                {% endif %}

                <!-- Transaction & Notes Removed per user request -->

                <div class="pt-4 flex justify-end gap-3">
                    <a href="{{ next_url or (url_for('admin.sales_list') if current_user.role == 'admin' else url_for('closer.dashboard')) }}"
                        class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 text-sm font-medium">Cancelar</a>
                    {{ form.submit(class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 text-sm
                    font-bold cursor-pointer") }}
                </div>
            </form>
        </div>
    </main>
</div>

<script>
    const searchInput = document.getElementById('lead_search');
    const resultsDiv = document.getElementById('search-results');
    const leadIdField = document.getElementById('lead_id');
    let timeout = null;

    searchInput.addEventListener('input', function () {
        clearTimeout(timeout);
        const query = this.value;

        if (query.length < 2) {
            resultsDiv.classList.add('hidden');
            return;
        }

        timeout = setTimeout(() => {
            fetch(`{{ url_for('closer.search_leads') }}?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    resultsDiv.innerHTML = '';
                    if (data.results.length > 0) {
                        resultsDiv.classList.remove('hidden');
                        data.results.forEach(item => {
                            const div = document.createElement('div');
                            div.className = 'p-3 hover:bg-indigo-50 cursor-pointer text-sm text-gray-700 border-b last:border-0';
                            div.textContent = item.text;
                            div.onclick = () => {
                                searchInput.value = item.text.split(' -')[0]; // Set input to name
                                leadIdField.value = item.id; // Set Hidden ID
                                resultsDiv.classList.add('hidden');
                            };
                            resultsDiv.appendChild(div);
                        });
                    } else {
                        resultsDiv.classList.add('hidden');
                    }
                });
        }, 300);
    });

    // Hide results when clicking outside
    document.addEventListener('click', function (e) {
        if (!searchInput.contains(e.target) && !resultsDiv.contains(e.target)) {
            resultsDiv.classList.add('hidden');
        }
    });
</script>
{% endblock %}