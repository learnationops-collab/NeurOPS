{% extends "layouts/base.html" %}

{% block content %}
<div class="flex h-screen overflow-hidden">
    {% include "includes/admin_sidebar.html" %}

    <div class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-50 p-6">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold text-gray-800">Constructor de Funnel</h1>

            <div class="flex space-x-2 items-center">
                <form method="GET" class="flex items-center gap-2">
                    <select name="target" onchange="this.form.submit()"
                        class="text-sm border-gray-300 rounded shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                        <option value="global">Global (Defecto)</option>
                        {% for g in groups %}
                        <option value="group_{{ g.id }}" {% if selected_target=='group_' ~ g.id %}selected{% endif %}>
                            Grupo: {{ g.name }}</option>
                        {% endfor %}
                        {% for e in events %}
                        <option value="event_{{ e.id }}" {% if selected_target=='event_' ~ e.id %}selected{% endif %}>
                            Evento: {{ e.name }}</option>
                        {% endfor %}
                    </select>
                </form>
                <a href="{{ url_for('admin.survey_mgmt') }}"
                    class="bg-gray-200 text-gray-700 px-4 py-2 rounded hover:bg-gray-300 transition font-bold shadow-sm">
                    Volver
                </a>
                <button onclick="saveFunnelState()"
                    class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 transition font-bold shadow-sm">
                    Guardar Cambios
                </button>
            </div>
        </div>

        <p class="text-gray-500 mb-6 text-sm">Arrastra las secciones para cambiar el orden del flujo. Arrastra las
            preguntas para moverlas entre "Landing" y "Encuesta", o para reordenarlas.</p>

        <!-- Funnel Container (Sortable Sections) -->
        <div id="funnel-sections" class="space-y-6 max-w-4xl mx-auto">

            <!-- We will render sections based on funnel_steps order -->
            {% for step_key in funnel_steps %}

            {% if step_key == 'contact' %}
            <!-- CONTACT SECTION -->
            <div class="funnel-section bg-white rounded-lg shadow border border-gray-200" data-id="contact">
                <div
                    class="bg-blue-50 px-6 py-3 border-b border-gray-200 flex justify-between items-center cursor-move handle-section">
                    <h3 class="font-bold text-blue-800 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10 6H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V8a2 2 0 00-2-2h-5m-4 0V5a2 2 0 114 0v1m-4 0a2 2 0 104 0m-5 8a2 2 0 100-4 2 2 0 000 4zm0 0c1.306 0 2.417.835 2.83 2M9 14a3.001 3.001 0 00-2.83 2M15 11h3m-3 4h2">
                            </path>
                        </svg>
                        1. Datos de Contacto (Landing)
                    </h3>
                    <span class="text-xs text-blue-600 font-medium">Paso Inicial (Sugerido)</span>
                </div>
                <div class="p-4" id="list-landing">
                    <p class="text-xs text-gray-400 mb-2">Preguntas que el usuario responde ANTES de ver el calendario.
                    </p>
                    <!-- Question Items -->
                    {% for q in questions_landing %}
                    <div class="question-item bg-gray-50 border border-gray-200 rounded p-3 mb-2 flex justify-between items-center cursor-move hover:bg-white transition"
                        data-id="{{ q.id }}">
                        <span class="text-sm font-medium text-gray-700">{{ q.text }} <span
                                class="text-gray-400 font-normal">({{ q.question_type }})</span></span>
                        {% if q.mapping_field %}
                        <span class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded border border-green-200">{{
                            q.mapping_field }}</span>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>

            {% elif step_key == 'calendar' %}
            <!-- CALENDAR SECTION -->
            <div class="funnel-section bg-white rounded-lg shadow border border-gray-200" data-id="calendar">
                <div
                    class="bg-purple-50 px-6 py-3 border-b border-gray-200 flex justify-between items-center cursor-move handle-section">
                    <h3 class="font-bold text-purple-800 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z">
                            </path>
                        </svg>
                        2. Agendamiento (Calendario)
                    </h3>
                </div>
                <div class="p-8 text-center bg-gray-50 text-gray-400 text-sm">
                    El usuario seleccionará fecha y hora en este paso.
                </div>
            </div>

            {% elif step_key == 'survey' %}
            <!-- SURVEY SECTION -->
            <div class="funnel-section bg-white rounded-lg shadow border border-gray-200" data-id="survey">
                <div
                    class="bg-indigo-50 px-6 py-3 border-b border-gray-200 flex justify-between items-center cursor-move handle-section">
                    <h3 class="font-bold text-indigo-800 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01">
                            </path>
                        </svg>
                        3. Encuesta de Calificación
                    </h3>
                </div>
                <div class="p-4" id="list-survey">
                    <p class="text-xs text-gray-400 mb-2">Preguntas adicionales.</p>
                    {% for q in questions_survey %}
                    <div class="question-item bg-gray-50 border border-gray-200 rounded p-3 mb-2 flex justify-between items-center cursor-move hover:bg-white transition"
                        data-id="{{ q.id }}">
                        <span class="text-sm font-medium text-gray-700">{{ q.text }} <span
                                class="text-gray-400 font-normal">({{ q.question_type }})</span></span>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            {% endfor %}

        </div>

    </div>
</div>

<!-- SortableJS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
<script>
    // 1. Sortable for Funnel Sections (Reorder Steps)
    new Sortable(document.getElementById('funnel-sections'), {
        animation: 150,
        handle: '.handle-section'
    });

    // 2. Sortable for Questions (Landing)
    var landingList = document.getElementById('list-landing');
    new Sortable(landingList, {
        group: 'questions', // Allow dragging between lists
        animation: 150,
        ghostClass: 'bg-blue-100'
    });

    // 3. Sortable for Questions (Survey)
    var surveyList = document.getElementById('list-survey');
    new Sortable(surveyList, {
        group: 'questions',
        animation: 150,
        ghostClass: 'bg-indigo-100'
    });

    function saveFunnelState() {
        // Collect Section Order
        let sections = [];
        document.querySelectorAll('.funnel-section').forEach(el => {
            sections.push(el.getAttribute('data-id'));
        });

        // Collect Questions Order & Step
        let questions = [];

        // Landing Questions
        document.querySelectorAll('#list-landing .question-item').forEach((el, index) => {
            questions.push({
                id: el.getAttribute('data-id'),
                step: 'landing',
                order: index + 1
            });
        });

        // Survey Questions
        document.querySelectorAll('#list-survey .question-item').forEach((el, index) => {
            questions.push({
                id: el.getAttribute('data-id'),
                step: 'survey',
                order: index + 1
            });
        });

        // Send to API
        fetch("{{ url_for('admin.save_funnel_state') }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                target: "{{ selected_target }}",
                funnel_steps: sections,
                questions: questions
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('¡Cambios guardados correctamente!');
                    location.reload();
                } else {
                    alert('Error al guardar: ' + data.message);
                }
            })
            .catch(err => {
                console.error(err);
                alert('Error de conexión.');
            });
    }
</script>
{% endblock %}