{% extends "layouts/base.html" %}

{% block content %}
<div class="flex h-screen overflow-hidden">
    {% include "includes/admin_sidebar.html" %}

    <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-50 p-6">
        <h1 class="text-2xl font-bold text-gray-800 mb-6">Estad√≠sticas de Closers (Manual)</h1>

        <!-- Filter Bar -->
        <div class="bg-white p-4 rounded-lg shadow-sm mb-6">
            <form method="get" class="flex flex-wrap gap-4 items-end">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Closer</label>
                    <select name="closer_id" class="border-gray-300 rounded-md shadow-sm focus:ring-indigo-500">
                        <option value="">Todos</option>
                        {% for c in closers %}
                        <option value="{{ c.id }}" {% if selected_closer==c.id|string %}selected{% endif %}>{{
                            c.username }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Desde</label>
                    <input type="date" name="start_date" value="{{ start_date }}"
                        class="border-gray-300 rounded-md shadow-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Hasta</label>
                    <input type="date" name="end_date" value="{{ end_date }}"
                        class="border-gray-300 rounded-md shadow-sm">
                </div>
                <button type="submit"
                    class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">Filtrar</button>
            </form>
        </div>

        <!-- KPI Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-blue-500">
                <div class="text-xs text-gray-500 uppercase font-bold">Show Rate</div>
                <div class="text-2xl font-bold text-gray-800">{{ "%.1f"|format(kpis.show_rate) }}%</div>
                <div class="text-xs text-gray-400">{{ total.calls_completed }} / {{ total.calls_scheduled }}</div>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-green-500">
                <div class="text-xs text-gray-500 uppercase font-bold">Closing Rate</div>
                <div class="text-2xl font-bold text-gray-800">{{ "%.1f"|format(kpis.closing_rate) }}%</div>
                <div class="text-xs text-gray-400">Sobre Completadas</div>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-yellow-500">
                <div class="text-xs text-gray-500 uppercase font-bold">Ticket Promedio</div>
                <div class="text-2xl font-bold text-gray-800">${{ "%.0f"|format(kpis.avg_ticket) }}</div>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-purple-500">
                <div class="text-xs text-gray-500 uppercase font-bold">Ventas Totales</div>
                <div class="text-2xl font-bold text-gray-800">{{ total.sales_count }}</div>
                <div class="text-xs text-gray-400">${{ "{:,.0f}".format(total.cash_collected) }} Cash</div>
            </div>
        </div>

        <!-- Detailed Table -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden overflow-x-auto">
            <table class="w-full text-left text-sm whitespace-nowrap">
                <thead class="bg-gray-50 border-b border-gray-200 text-gray-500 uppercase text-xs">
                    <tr>
                        <th class="px-4 py-3">Fecha</th>
                        <th class="px-4 py-3">Closer</th>
                        <th class="px-4 py-3 text-center bg-blue-50">Agenda</th>
                        <th class="px-4 py-3 text-center bg-blue-50">Completadas</th>
                        <th class="px-4 py-3 text-center bg-red-50">No Show</th>
                        <th class="px-4 py-3 text-center bg-gray-50">Cancel</th>
                        <th class="px-4 py-3 text-center bg-green-50">Ventas</th>
                        <th class="px-4 py-3 text-center bg-green-50">Monto</th>
                        <th class="px-4 py-3 text-center">Self Gen</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    {% for stat in stats %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 font-medium">{{ stat.date.strftime('%Y-%m-%d') }}</td>
                        <td class="px-4 py-3">{{ stat.closer.username }}</td>
                        <td class="px-4 py-3 text-center bg-blue-50/50">{{ stat.calls_scheduled or 0 }}</td>
                        <td class="px-4 py-3 text-center bg-blue-50/50 font-bold">{{ stat.calls_completed or 0 }}</td>
                        <td class="px-4 py-3 text-center bg-red-50/50 text-red-600">{{ stat.calls_no_show or 0 }}</td>
                        <td class="px-4 py-3 text-center bg-gray-50/50 text-gray-500">{{ stat.calls_canceled or 0 }}
                        </td>
                        <td class="px-4 py-3 text-center bg-green-50/50 font-bold text-green-700">{{ stat.sales_count or
                            0 }}
                        </td>
                        <td class="px-4 py-3 text-center bg-green-50/50 text-green-700">${{
                            "{:,.0f}".format(stat.sales_amount or 0) }}</td>
                        <td class="px-4 py-3 text-center">{{ stat.self_generated_bookings or 0 }}</td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="9" class="p-8 text-center text-gray-500">No hay reportes en este periodo.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </main>
</div>
{% endblock %}