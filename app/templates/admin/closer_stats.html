{% extends "layouts/base.html" %}

{% block content %}
<div class="flex h-screen overflow-hidden">
    {% include "includes/admin_sidebar.html" %}

    <main
        class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-50 dark:bg-gray-900 p-6 transition-colors duration-300">
        <h1 class="text-2xl font-bold text-gray-800 dark:text-white mb-6">Métricas de Closers</h1>

        <!-- Filter Bar -->
        <div
            class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-sm border border-gray-100 dark:border-gray-700 mb-6">
            <form method="get" class="flex flex-wrap gap-4 items-end" id="filterForm">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Periodo</label>
                    <select name="period" id="periodSelect" onchange="toggleDates()"
                        class="border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                        <option value="today" {% if period=='today' %}selected{% endif %}>Hoy</option>
                        <option value="this_month" {% if period=='this_month' %}selected{% endif %}>Este Mes</option>
                        <option value="custom" {% if period=='custom' %}selected{% endif %}>Personalizado</option>
                    </select>
                </div>

                <div id="customDates" class="flex gap-4" style="{% if period != 'custom' %}display:none;{% endif %}">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Desde</label>
                        <input type="date" name="start_date" value="{{ start_date }}"
                            class="border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Hasta</label>
                        <input type="date" name="end_date" value="{{ end_date }}"
                            class="border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Closer</label>
                    <select name="closer_id"
                        class="border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                        <option value="">Todos</option>
                        {% for c in closers %}
                        <option value="{{ c.id }}" {% if selected_closer==c.id|string %}selected{% endif %}>{{
                            c.username }}</option>
                        {% endfor %}
                    </select>
                </div>

                <button type="submit"
                    class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 dark:hover:bg-indigo-500 transition">Filtrar</button>
            </form>

            <script>
                function toggleDates() {
                    const select = document.getElementById('periodSelect');
                    const dates = document.getElementById('customDates');
                    if (select.value === 'custom') {
                        dates.style.display = 'flex';
                    } else {
                        dates.style.display = 'none';
                        // Optional: Auto-submit when switching to preset? 
                        // User might want to change Closer first. Let's keep manual submit or auto-submit on preset change.
                        // "Hagamoslo simple: Boton Filtrar siempre"
                    }
                }
            </script>
        </div>

        <!-- Row 1: Volume & Capacity -->
        <h3 class="text-lg font-bold text-gray-700 dark:text-gray-200 mb-2">Volumen y Capacidad</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <!-- Slots -->
            <div
                class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 transition">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <p class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wide">Slots
                            (Disponibilidad)</p>
                        <h2 class="text-3xl font-bold text-gray-800 dark:text-white mt-1">{{ metrics.slots.total }}</h2>
                    </div>
                    <div class="p-2 bg-blue-50 dark:bg-blue-900/30 rounded-lg text-blue-600 dark:text-blue-400">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z">
                            </path>
                        </svg>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4 mt-4 text-sm">
                    <div class="bg-gray-50 dark:bg-gray-700/50 p-2 rounded">
                        <span class="block text-gray-500 dark:text-gray-400 text-xs">Agendados</span>
                        <span class="font-bold text-gray-800 dark:text-gray-200">{{ metrics.slots.used }}</span>
                    </div>
                    <div class="bg-green-50 dark:bg-green-900/20 p-2 rounded">
                        <span class="block text-green-600 dark:text-green-400 text-xs">Libres</span>
                        <span class="font-bold text-green-700 dark:text-green-300">{{ metrics.slots.available }}</span>
                    </div>
                </div>
            </div>

            <!-- First Agendas -->
            <div
                class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 transition">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <p class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wide">Primeras
                            Agendas</p>
                        <h2 class="text-3xl font-bold text-gray-800 dark:text-white mt-1">{{
                            metrics.agendas.first_agendas.total }}</h2>
                    </div>
                    <div class="p-2 bg-indigo-50 dark:bg-indigo-900/30 rounded-lg text-indigo-600 dark:text-indigo-400">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z">
                            </path>
                        </svg>
                    </div>
                </div>
                <div class="space-y-2 text-xs">
                    <div class="flex justify-between">
                        <span class="text-gray-500 dark:text-gray-400">Pendientes</span>
                        <span class="font-bold text-orange-600 dark:text-orange-400">{{
                            metrics.agendas.first_agendas.scheduled }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-500 dark:text-gray-400">Confirmadas</span>
                        <span class="font-bold text-green-600 dark:text-green-400">{{
                            metrics.agendas.first_agendas.confirmed }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-500 dark:text-gray-400">Completadas</span>
                        <span class="font-bold text-gray-800 dark:text-gray-200">{{
                            metrics.agendas.first_agendas.completed }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-500 dark:text-gray-400">No Show</span>
                        <span class="font-bold text-red-600 dark:text-red-400">{{ metrics.agendas.first_agendas.no_show
                            }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-500 dark:text-gray-400">Canceladas</span>
                        <span class="font-bold text-gray-600 dark:text-gray-300">{{
                            metrics.agendas.first_agendas.canceled }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-500 dark:text-gray-400">Reprogramadas</span>
                        <span class="font-bold text-blue-600 dark:text-blue-400">{{
                            metrics.agendas.first_agendas.rescheduled }}</span>
                    </div>
                </div>
            </div>

            <!-- Second Agendas -->
            <div
                class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 transition">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <p class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wide">Segundas
                            Agendas</p>
                        <h2 class="text-3xl font-bold text-gray-800 dark:text-white mt-1">{{
                            metrics.agendas.second_agendas.total }}
                        </h2>
                    </div>
                    <div class="p-2 bg-yellow-50 dark:bg-yellow-900/30 rounded-lg text-yellow-600 dark:text-yellow-400">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                            </path>
                        </svg>
                    </div>
                </div>
                <div class="space-y-2 text-xs">
                    <div class="flex justify-between">
                        <span class="text-gray-500 dark:text-gray-400">Pendientes</span>
                        <span class="font-bold text-orange-600 dark:text-orange-400">{{
                            metrics.agendas.second_agendas.scheduled }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-500 dark:text-gray-400">Confirmadas</span>
                        <span class="font-bold text-green-600 dark:text-green-400">{{
                            metrics.agendas.second_agendas.confirmed }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-500 dark:text-gray-400">Completadas</span>
                        <span class="font-bold text-gray-800 dark:text-gray-200">{{
                            metrics.agendas.second_agendas.completed }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-500 dark:text-gray-400">No Show</span>
                        <span class="font-bold text-red-600 dark:text-red-400">{{ metrics.agendas.second_agendas.no_show
                            }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-500 dark:text-gray-400">Canceladas</span>
                        <span class="font-bold text-gray-600 dark:text-gray-300">{{
                            metrics.agendas.second_agendas.canceled }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-500 dark:text-gray-400">Reprogramadas</span>
                        <span class="font-bold text-blue-600 dark:text-blue-400">{{
                            metrics.agendas.second_agendas.rescheduled }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Row 2: Conversion -->
        <h3 class="text-lg font-bold text-gray-700 dark:text-gray-200 mb-2">Conversión y Resultados</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Presentations -->
            <div
                class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-l-4 border-l-indigo-500 dark:border-l-indigo-400 dark:border-y-gray-700 dark:border-r-gray-700">
                <div class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-1">
                    Presentaciones</div>
                <div class="text-3xl font-bold text-indigo-900 dark:text-indigo-100">{{ metrics.agendas.presentations }}
                </div>
                <div class="mt-2 text-xs text-indigo-600 dark:text-indigo-400 font-medium">
                    {{ "%.1f"|format(metrics.kpis.presentation_rate) }}% de Completadas
                </div>
            </div>

            <!-- Sales -->
            <div
                class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-l-4 border-l-green-500 dark:border-l-green-400 dark:border-y-gray-700 dark:border-r-gray-700">
                <div class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-1">Cierres
                    (Ventas)</div>
                <div class="text-3xl font-bold text-green-900 dark:text-green-100">{{ metrics.sales }}</div>
                <div class="mt-2 text-xs text-green-600 dark:text-green-400 font-medium">
                    {{ "%.1f"|format(metrics.kpis.closing_rate_presentation) }}% de Presentaciones
                </div>
            </div>

            <!-- Show Up Rate -->
            <div
                class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-l-4 border-l-blue-500 dark:border-l-blue-400 dark:border-y-gray-700 dark:border-r-gray-700">
                <div class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-1">Show Up
                    Rate</div>
                <div class="text-3xl font-bold text-blue-900 dark:text-blue-100">{{
                    "%.1f"|format(metrics.kpis.show_up_rate) }}%</div>
                <div class="mt-2 text-xs text-blue-600 dark:text-blue-400 font-medium">
                    Completadas / Totales
                </div>
            </div>

            <!-- Closing Rate Global -->
            <div
                class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-l-4 border-l-purple-500 dark:border-l-purple-400 dark:border-y-gray-700 dark:border-r-gray-700">
                <div class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-1">Cierre
                    Global</div>
                <div class="text-3xl font-bold text-purple-900 dark:text-purple-100">{{
                    "%.1f"|format(metrics.kpis.closing_rate_global) }}%
                </div>
                <div class="mt-2 text-xs text-purple-600 dark:text-purple-400 font-medium">
                    Cierres / Completadas
                </div>
            </div>
        </div>

        <!-- Row 3: Negative KPIs -->
        <h3 class="text-lg font-bold text-gray-700 dark:text-gray-200 mb-2">Métricas Operativas</h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-sm border border-gray-100 dark:border-gray-700">
                <p class="text-xs text-gray-500 dark:text-gray-400 uppercase">Tasa Cancelación</p>
                <p class="text-xl font-bold text-gray-700 dark:text-gray-200">{{
                    "%.1f"|format(metrics.kpis.cancellation_rate) }}%</p>
            </div>
            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-sm border border-gray-100 dark:border-gray-700">
                <p class="text-xs text-gray-500 dark:text-gray-400 uppercase">Tasa Reprogramación</p>
                <p class="text-xl font-bold text-gray-700 dark:text-gray-200">{{
                    "%.1f"|format(metrics.kpis.reschedule_rate) }}%</p>
            </div>
        </div>

    </main>
</div>
{% endblock %}