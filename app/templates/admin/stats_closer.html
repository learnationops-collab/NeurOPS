{% extends "layouts/base.html" %}

{% block content %}
<div class="flex h-screen overflow-hidden">
    {% include "includes/admin_sidebar.html" %}
    <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-50">
        <div class="px-6 py-8">
            <!-- Header & Filters -->
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">Estadísticas de Closers</h1>
                    <p class="text-sm text-gray-500 mt-1">Reportes diarios (KPIs y Cualitativos)</p>
                </div>

                <form class="flex flex-wrap gap-2 items-end bg-white p-2 rounded-lg border border-gray-200 shadow-sm">
                    <div>
                        <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Inicio</label>
                        <input type="date" name="start_date" value="{{ start_date }}"
                            class="text-sm border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Fin</label>
                        <input type="date" name="end_date" value="{{ end_date }}"
                            class="text-sm border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Closer</label>
                        <select name="closer_id"
                            class="text-sm border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 bg-white">
                            <option value="">Todos</option>
                            {% for c in closers %}
                            <option value="{{ c.id }}" {% if request.args.get('closer_id')|int==c.id %}selected{% endif
                                %}>{{
                                c.username }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <button type="submit"
                        class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md font-medium text-sm transition-colors">
                        Filtrar
                    </button>
                </form>
            </div>

            <!-- Totals Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
                    <dt class="text-xs font-bold text-gray-500 uppercase tracking-wider truncate">Ventas Totales</dt>
                    <dd class="mt-2 text-3xl font-black text-slate-800">{{ total_sales }}</dd>
                    <div class="mt-2 h-1 w-12 bg-indigo-500 rounded"></div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
                    <dt class="text-xs font-bold text-gray-500 uppercase tracking-wider truncate">Recaudación Net</dt>
                    <dd class="mt-2 text-3xl font-black text-emerald-600">${{ "{:,.0f}".format(total_cash) }}</dd>
                    <div class="mt-2 h-1 w-12 bg-emerald-500 rounded"></div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
                    <dt class="text-xs font-bold text-gray-500 uppercase tracking-wider truncate">Llamadas (OK)</dt>
                    <dd class="mt-2 text-3xl font-black text-blue-600">{{ total_calls }}</dd>
                    <div class="mt-2 h-1 w-12 bg-blue-500 rounded"></div>
                </div>
                <div
                    class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition-shadow transition-shadow">
                    <dt class="text-xs font-bold text-gray-500 uppercase tracking-wider truncate">Tasa de Cierre</dt>
                    <dd class="mt-2 text-3xl font-black text-purple-600">{{ "%.1f"|format(closing_rate) }}%</dd>
                    <div class="mt-2 h-1 w-12 bg-purple-500 rounded"></div>
                </div>
            </div>

            <!-- Consolidated Table -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-gray-50 border-b border-gray-200">
                                <th
                                    class="px-6 py-4 text-xs font-bold text-gray-500 uppercase tracking-wider sticky left-0 bg-gray-50 min-w-[150px] z-10 border-r border-gray-200">
                                    Fecha / Closer</th>

                                <!-- Automated Financials (Fixed) -->
                                <th
                                    class="px-4 py-4 text-xs font-bold text-gray-500 uppercase tracking-wider text-center bg-green-50">
                                    Ventas (Auto)</th>
                                <th
                                    class="px-4 py-4 text-xs font-bold text-gray-500 uppercase tracking-wider text-center bg-green-50">
                                    Cash (Auto)</th>

                                <!-- Dynamic Questions Headers -->
                                {% for q in questions %}
                                <th
                                    class="px-4 py-4 text-xs font-bold text-gray-500 uppercase tracking-wider min-w-[120px] text-center whitespace-normal border-l border-gray-100">
                                    {{ q.text }}
                                </th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            {% for stat in stats %}
                            <tr class="hover:bg-gray-50 transition-colors">
                                <td
                                    class="px-6 py-4 whitespace-nowrap sticky left-0 bg-white group-hover:bg-gray-50 border-r border-gray-200 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)] z-10">
                                    <div class="flex items-center">
                                        <div>
                                            <div class="text-sm font-medium text-gray-900">{{
                                                stat.date.strftime('%d/%m') }}
                                            </div>
                                            <div class="text-xs text-gray-500">{{ stat.closer.username }}</div>
                                        </div>
                                    </div>
                                </td>

                                <!-- Automated Financials -->
                                <td class="px-4 py-4 text-center whitespace-nowrap bg-green-50/30">
                                    <span class="text-sm font-bold text-gray-800">{{ stat.sales_count }}</span>
                                    <span class="text-xs text-gray-400 block">${{ "{:,.0f}".format(stat.sales_amount)
                                        }}</span>
                                </td>
                                <td class="px-4 py-4 text-center whitespace-nowrap bg-green-50/30">
                                    <span class="text-sm font-bold text-green-700">${{
                                        "{:,.0f}".format(stat.cash_collected)
                                        }}</span>
                                </td>

                                <!-- Dynamic Answers -->
                                {% for q in questions %}
                                {% set ans = stat.answers.filter_by(question_id=q.id).first() %}
                                <td class="px-4 py-4 text-sm text-gray-600 border-l border-gray-100 text-center">
                                    {% if ans %}
                                    {% if q.question_type == 'boolean' %}
                                    {% if ans.answer == 'true' or ans.answer == '1' %}
                                    <span class="text-green-600 font-bold">✓</span>
                                    {% else %}
                                    <span class="text-red-400">✗</span>
                                    {% endif %}
                                    {% else %}
                                    <span class="truncate block max-w-[200px] mx-auto" title="{{ ans.answer }}">
                                        {{ ans.answer }}
                                    </span>
                                    {% endif %}
                                    {% else %}
                                    <span class="text-gray-300">-</span>
                                    {% endif %}
                                </td>
                                {% endfor %}
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="{{ 3 + questions|length }}" class="px-6 py-12 text-center text-gray-400">
                                    No hay reportes para el periodo seleccionado.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="bg-gray-100 border-t-2 border-gray-200">
                            <tr>
                                <td
                                    class="px-6 py-4 text-xs font-bold text-gray-700 uppercase sticky left-0 bg-gray-100 border-r border-gray-200 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)] z-10">
                                    Totales
                                </td>

                                <!-- Automated Totals -->
                                <td class="px-4 py-4 text-center font-bold text-gray-800 bg-green-100/50">
                                    {{ total_sales }}
                                    <span class="block text-xs font-normal text-gray-500">${{
                                        "{:,.0f}".format(total_sales * 1500) }} (Est)</span>
                                    <!-- Note: Sales Amount Sum not passed as variable, using simple calc or just showing count? 
                                         Ideally we should pass total_sales_amount from backend too if needed. 
                                         For now, let's just show count. -->
                                </td>
                                <td class="px-4 py-4 text-center font-bold text-green-700 bg-green-100/50">
                                    ${{ "{:,.0f}".format(total_cash) }}
                                </td>

                                <!-- Dynamic Question Totals -->
                                {% for q in questions %}
                                <td
                                    class="px-4 py-4 text-center text-sm font-bold text-gray-700 border-l border-gray-200">
                                    {% if questions_totals[q.id] is not none %}
                                    {{ "{:,.0f}".format(questions_totals[q.id]) }}
                                    {% else %}
                                    -
                                    {% endif %}
                                </td>
                                {% endfor %}
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
</div>
</main>
</div>
{% endblock %}